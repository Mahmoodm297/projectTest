pipeline {
    agent any
	
	environment {
		BUILD = 'postgres'
		BRANCH = 'main'
		POSTGRES_DB = 'csvDB'
		Port = '5432'
		PGDATA = '/local/DB'
		POSTGRES_HOST = 'localhost'

	}

	stages {
	
    		stage ('retrieve git repo locally') {
			steps {
			      git branch: 'main' , credentialsId: 'GitHub', url: 'https://github.com/Mahmoodm297/projectTest.git'
           		      sh "ls -la"
			}
          	}
		
		stage ('Create a Dockerfile') {
			steps {	
				withCredentials([usernamePassword(credentialsId: 'postgres', usernameVariable: 'POSTGRES_USER', passwordVariable: 'POSTGRES_PASSWORD')]) {
					echo "FROM postgres
					ENV POSTGRES_HOST=${env.POSTGRES_HOST}
					ENV POSTGRES_USER=${POSTGRES_USER}
					ENV POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
					ENV POSTGRES_DB=${env.POSTGRES_DB}
					EXPOSE 5432" > Dockerfile
				}
			}
		}
	
		stage ('Run Postgres Dockerfile') {
			steps {	
				withCredentials([usernamePassword(credentialsId: 'postgres', usernameVariable: 'POSTGRES_USER', passwordVariable: 'POSTGRES_PASSWORD')]) {
					docker.image('postgres:9.6').withRun(' -h ${env.POSTGRES_HOST} -e "POSTGRES_USER=${POSTGRES_USER}" -e "POSTGRES_PASSWORD=${POSTGRES_PASSWORD}" -t postgress '){ c ->
						echo "Running DockerPostgress"
					}

				}
			}
		}
	}
}
